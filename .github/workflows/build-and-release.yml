name: Build and Release

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:

env:
  FLUTTER_VERSION: '3.29.0'

jobs:
  build-android:
    name: Build Android APK
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          cache: true

      - name: Get dependencies
        run: flutter pub get

      - name: Build APK
        run: flutter build apk --release

      - name: Upload APK artifact
        uses: actions/upload-artifact@v4
        with:
          name: android-apk
          path: build/app/outputs/flutter-apk/app-release.apk

  build-windows:
    name: Build Windows EXE
    runs-on: windows-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          cache: true

      - name: Get dependencies
        run: flutter pub get

      - name: Build Windows
        run: flutter build windows --release

      - name: Package Windows with dependencies
        shell: pwsh
        run: |
          # Create release directory
          New-Item -ItemType Directory -Force -Path release/prompt_memo_windows

          # Copy all build files
          Copy-Item -Path "build/windows/x64/runner/Release/*" -Destination "release/prompt_memo_windows/" -Recurse

          # Note: sqflite_common_ffi usually includes sqlite3.dll automatically
          # But we verify it exists in the output

          # Create zip archive
          Compress-Archive -Path "release/prompt_memo_windows/*" -DestinationPath "release/prompt_memo_windows.zip"

      - name: Upload Windows artifact
        uses: actions/upload-artifact@v4
        with:
          name: windows-exe
          path: release/prompt_memo_windows.zip

  build-linux:
    name: Build Linux
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          cache: true

      - name: Get dependencies
        run: flutter pub get

      - name: Build Linux
        run: flutter build linux --release

      - name: Package Linux with dependencies
        run: |
          # Create release directory
          mkdir -p release/prompt_memo_linux

          # Copy bundle
          cp -r build/linux/x64/release/bundle/* release/prompt_memo_linux/

          # Copy sqlite3 library
          cp /lib/x86_64-linux-gnu/libsqlite3.so.0 release/prompt_memo_linux/

          # Create startup script that sets library path
          cat > release/prompt_memo_linux/run.sh << 'EOF'
          #!/bin/bash
          # Get the directory where this script is located
          DIR="$( cd "$( dirname "${BASH_SOURCE[0]}" )" && pwd )"
          # Add current directory to library path and run the app
          export LD_LIBRARY_PATH="$DIR:$LD_LIBRARY_PATH"
          exec "$DIR/prompt_memo"
          EOF
          chmod +x release/prompt_memo_linux/run.sh

          # Create tar.gz archive
          cd release
          tar -czf prompt_memo_linux.tar.gz prompt_memo_linux/

      - name: Create README for Linux
        run: |
          cat > release/README_LINUX.md << 'EOF'
          # Prompt Memo - Linux å®‰è£…è¯´æ˜Ž

          ## æ–¹æ³•1ï¼šä½¿ç”¨å¯åŠ¨è„šæœ¬ï¼ˆæŽ¨èï¼‰

          1. è§£åŽ‹ `prompt_memo_linux.tar.gz`
          2. è¿›å…¥è§£åŽ‹åŽçš„ç›®å½•
          3. è¿è¡Œï¼š`./run.sh`

          ## æ–¹æ³•2ï¼šæ‰‹åŠ¨è®¾ç½®åº“è·¯å¾„

          1. è§£åŽ‹ `prompt_memo_linux.tar.gz`
          2. è¿›å…¥è§£åŽ‹åŽçš„ç›®å½•
          3. è¿è¡Œï¼š
             ```
             LD_LIBRARY_PATH=. ./prompt_memo
             ```

          ## æ–¹æ³•3ï¼šå®‰è£…sqlite3ï¼ˆç³»ç»Ÿçº§ï¼‰

          Ubuntu/Debian:
          ```bash
          sudo apt-get install sqlite3 libsqlite3-dev
          ```

          Fedora/RHEL:
          ```bash
          sudo dnf install sqlite3 sqlite-devel
          ```

          Arch Linux:
          ```bash
          sudo pacman -S sqlite
          ```

          å®‰è£…åŽå¯ä»¥ç›´æŽ¥è¿è¡Œ `./prompt_memo`
          EOF

      - name: Upload Linux artifact
        uses: actions/upload-artifact@v4
        with:
          name: linux-bundle
          path: release/prompt_memo_linux.tar.gz

  create-release:
    name: Create GitHub Release
    needs: [build-android, build-windows, build-linux]
    runs-on: ubuntu-latest
    permissions:
      contents: write
    if: startsWith(github.ref, 'refs/tags/')
    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4

      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          files: |
            android-apk/app-release.apk
            windows-exe/prompt_memo_windows.zip
            linux-bundle/prompt_memo_linux.tar.gz
          body: |
            ## Prompt Memo v${{ github.ref_name }}

            ### ðŸ“¦ ä¸‹è½½è¯´æ˜Ž

            #### Android (.apk)
            - ç›´æŽ¥ä¸‹è½½å¹¶å®‰è£…ï¼Œæ— éœ€é¢å¤–ä¾èµ–

            #### Windows (.zip)
            - è§£åŽ‹åŽè¿è¡Œ `prompt_memo.exe`
            - å¦‚é‡ç¼ºå°‘ DLL é”™è¯¯ï¼Œè¯·å®‰è£… [VC++ Redistributable](https://aka.ms/vs/17/release/vc_redist.x64.exe)

            #### Linux (.tar.gz)
            - è§£åŽ‹åŽè¿è¡Œ `./run.sh`
            - è¯¦ç»†è¯´æ˜Žè§ `README_LINUX.md`

            ### âœ¨ æ›´æ–°å†…å®¹
            - Bug fixes and improvements
            - Enhanced features
            - Performance optimizations
          draft: false
          prerelease: false
